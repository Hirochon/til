## django-allauthのメールアドレス確認時にマイページ作成機能の実装 (2020/2/10)
### リポジトリ: [Shappar](https://github.com/Hirochon/Shappar)

### 実装したい詳しい内容
- 問題点:サインアップと同時にマイページが作成されないので、ユーザーが即時にアプリを使えない状態になる。
1. まずどこでマイページを作成させるフラグを建てようかとても迷った。(※ログイン機能はallauthパッケージを採用しているため、コードを細部まで知り尽くしていなくて、シンプルに困惑。)
2. メールアドレス確認時にあからさま使うであろうPOSTの関数を発見したので、そこにMypage作成をねじ込むことを決めた。だが次の課題点が見えた。
3. 課題点:どうやってカスタムviewsクラスを適用させるか → `include('allauth')`でallauthのルーティングの設定は終わらせていたので、templateの接続先をイジるにはどうすればいいか悩んだ。
4. 前にallauthをcloneしていたので、とりあえず`urls.py`を見てみると、ルーティングの設定を全て分けていたので、これはもしやこっちでも全て定義してやったらいじれるのではないかと思い→◎イケた
5. `views.py`はとりあえずallauthのPOSTの関数はそのまま引っ張ってきて、importすべきなやつは全てimportして、動くかどうかしっかり確認。(実験より先に動作確認)
6. 実験開始。とりあえず下のようにして、saveできるかどうかを検証。

```python:views.py
user = self.request.user
mypage = Mypage(user=user)
mypage.save()
```

7. 実験成功。(あれうまくいいってもた感w)→すぐさま問題点を発見。
8. メール確認時にマイページを作成しているので、メールアドレスの変更などを行った時に、もう一つマイページが作成されることに気づく。
9. is_validがformでしか使えないことに驚きつつ、apiv1でmodels.MypageをMetaとしてすぐさまMypageFormを作成。
10. 以下のようにif文+バリデーションをかけてマイページの余分な作成を回避

```python:views.py
user = self.request.user
data = {}
data['user'] = user
mypage = MypageForm(data)
# バリデーションで同一ユーザーのマイページの複製を回避
if mypage.is_valid():
    mypage.save()
```

11. 今回の目標であるユーザ作成時(メールアドレス本確認時)にマイページの自動生成も実現。